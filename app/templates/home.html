<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Surge</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
</head>
<body>
    <nav class="navbar">
        <ul class="navbar-links">
            <li><a href="{{ url_for('home') }}">
                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Stock Surge Logo" class="logo" width="160px">
            </a></li>
            <li><a href="{{ url_for('trading') }}">Trading</a></li>
            <li><a href="{{ url_for('portfolio_page') }}">Portfolio</a></li>
            <li><a href="{{ url_for('transaction_history') }}">Transaction History</a></li>
            <li><a href="{{ url_for('deposit_cash') }}">Deposit Cash</a></li>
            <li><a href="{{ url_for('withdraw_cash') }}">Withdraw Cash</a></li>
        </ul>
        <div class="navbar-right" id="authSection">
            <!-- Will be populated by JavaScript -->
        </div>
    </nav>
    <div class="container">
        <section class="stock-display">
            <h2>Stock Market Overview</h2>
            <ul>
                <li>Apple (AAPL): $145.00 (+1.25%)</li>
                <li>Google (GOOG): $2750.50 (+0.85%)</li>
                <li>Amazon (AMZN): $3330.15 (-0.10%)</li>
                <li>Tesla (TSLA): $715.60 (+2.40%)</li>
            </ul>
        </section>

        <section class="financial-news">
            <h2>Latest Financial News</h2>
            <div id="newsContent">
                <!-- Will be populated by JavaScript -->
                <div class="loading">Loading latest news...</div>
            </div>
        </section>
    </div>

    <script>
        // Authentication section update
        function updateAuthSection() {
            const token = localStorage.getItem('access_token');
            const authSection = document.getElementById('authSection');
            
            if (token) {
                authSection.innerHTML = `
                    <span id="userBalance"></span>
                    <button onclick="logout()" class="nav-link logout-button">Log out</button>
                `;
                fetchUserBalance();
            } else {
                authSection.innerHTML = `
                    <a href="{{ url_for('login_page') }}" class="nav-link">Log on</a>
                    <a href="{{ url_for('new_account') }}" class="cta-button">Open an account</a>
                `;
            }
        }

        // News fetching function
        async function fetchLatestNews() {
            try {
                const response = await fetch('/api/news');
                const news = await response.json();
                
                const newsContent = document.getElementById('newsContent');
                newsContent.innerHTML = news.map(item => `
                    <div class="news-item">
                        <h3>${item.title}</h3>
                        <p>${item.description}</p>
                        <small>Source: ${item.source}</small>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error fetching news:', error);
                const newsContent = document.getElementById('newsContent');
                newsContent.innerHTML = '<div class="error">Error loading news. Please try again later.</div>';
            }
        }

        // User balance fetching function
        async function fetchUserBalance() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch('/user/balance', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('userBalance').textContent = 
                        `Balance: $${data.cash_balance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                }
            } catch (error) {
                console.error('Error fetching balance:', error);
            }
        }

        // Logout function
        function logout() {
            localStorage.removeItem('access_token');
            updateAuthSection();
            window.location.href = '/';
        }

        // Initialize everything when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            updateAuthSection();
            fetchLatestNews();  // Initial news fetch
            setInterval(fetchLatestNews, 10000);  // Refresh news every 10 seconds
        });
    </script>
</body>
</html>